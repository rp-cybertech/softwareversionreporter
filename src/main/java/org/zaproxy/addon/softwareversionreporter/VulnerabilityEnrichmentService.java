/*
 * Zed Attack Proxy (ZAP) and its related class files.
 *
 * ZAP is an HTTP/HTTPS proxy for assessing web application security.
 *
 * Copyright 2025 The ZAP Development Team
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.zaproxy.addon.softwareversionreporter;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.zaproxy.addon.softwareversionreporter.api.NVDClient;
import org.zaproxy.addon.softwareversionreporter.api.VulDBClient;
import org.zaproxy.addon.softwareversionreporter.api.VulnersClient;
import org.zaproxy.addon.softwareversionreporter.model.EnrichmentResult;
import org.zaproxy.addon.softwareversionreporter.util.CpeUtil;

public class VulnerabilityEnrichmentService {
    private static final Logger LOGGER = LogManager.getLogger(VulnerabilityEnrichmentService.class);
    private final SoftwareVersionReporterParam param;

    public VulnerabilityEnrichmentService(SoftwareVersionReporterParam param) {
        this.param = param;
    }

    private boolean isValidIdentifier(String s) {
        return s != null && !s.isBlank() && !s.equals("*");
    }

    public EnrichmentResult query(String software, String version, String vendor, String product) {
        String provider =
                param.getApiProvider() != null ? param.getApiProvider().toLowerCase() : "nvd";
        LOGGER.debug(
                "SVR enrichment: provider={} software={} version={} vendor={} product={}",
                provider,
                software,
                version,
                vendor,
                product);
        try {
            switch (provider) {
                case "vulners":
                    LOGGER.info("SVR:route Vulners software={} version={}", software, version);
                    return new VulnersClient(param.getVulnersApiKey())
                            .queryByProduct(software, version, vendor, product);
                case "vuldb":
                    LOGGER.info(
                            "SVR:route VulDB vendor={} product={} version={}",
                            vendor,
                            product,
                            version);
                    return new VulDBClient(param.getVuldbApiKey())
                            .query(software, version, vendor, product);
                default:
                    String cpe =
                            (isValidIdentifier(vendor) && isValidIdentifier(product))
                                    ? CpeUtil.build(
                                            vendor,
                                            product,
                                            version == null || version.isBlank() ? "*" : version)
                                    : null;
                    if (cpe == null || !cpe.startsWith("cpe:2.3:")) {
                        LOGGER.warn(
                                "SVR:NVD skipped â€” invalid CPE (vendor/product missing); falling back to Vulners software={} version={}",
                                software,
                                version);
                        return new VulnersClient(param.getVulnersApiKey())
                                .queryByProduct(software, version, vendor, product);
                    }
                    LOGGER.info(
                            "SVR:route NVD cpe={} software={} version={}", cpe, software, version);
                    return new NVDClient(param.getNvdApiKey())
                            .queryByCpe(product != null ? product : software, version, cpe);
            }
        } catch (Exception e) {
            LOGGER.error(
                    "SVR enrichment error software={} version={} vendor={} product={} provider={}",
                    software,
                    version,
                    vendor,
                    product,
                    provider,
                    e);
            EnrichmentResult er = new EnrichmentResult(software, version);
            er.setSource(provider);
            return er;
        }
    }
}
